## DHCP 协议
- Dynamic Host Configuration Protocol

- 从服务器动态获取：
	- IP 地址
	- 子网掩码
	- 默认网关地址
	- DNS 服务器名称与 IP 地址

- C/S 架构
- 即插即用
- 允许地址重用
- 支持在用地址续租
- 支持移动用户接入网络

### 配置过程
1. 主机广播 DHCP discover 发现报文
2. DHCP 服务器利用 DHCP offer 提供报文 进行响应
3. 主机请求 IP 地址 DHCP request 请求报文
4. DHCP 服务器分配 IP 地址 DHCP ack 确认报文

![[Pasted image 20251020081034.png]]
### DHCP报文IP地址解释

#### **1. DHCP Discover（发现）**

- **src: 0.0.0.0, 68**
    - 源IP：0.0.0.0（客户端还没有IP地址）
    - 源端口：68（DHCP客户端端口）
- **dest: 255.255.255.255, 67**
    - 目标IP：255.255.255.255（广播地址，寻找网络中的DHCP服务器）
    - 目标端口：67（DHCP服务器端口）

#### **2. DHCP Offer（提供）**

- **src: 223.1.2.5, 67**
    - 源IP：223.1.2.5（DHCP服务器的IP地址）
    - 源端口：67（DHCP服务器端口）
- **dest: 255.255.255.255, 68**
    - 目标IP：255.255.255.255（广播发送，因为客户端还没有IP）
    - 目标端口：68（DHCP客户端端口）
- **yiaddr: 223.1.2.4**
    - Your IP address：服务器提供给客户端的IP地址

#### **3. DHCP Request（请求）**

- **src: 0.0.0.0, 68**
    - 源IP：0.0.0.0（客户端此时仍未正式获得IP）
    - 源端口：68
- **dest: 255.255.255.255, 67**
    - 目标IP：255.255.255.255（广播，告知所有DHCP服务器选择结果）
    - 目标端口：67
- **yiaddr: 223.1.2.4**
    - 客户端请求的IP地址（来自Offer）

#### **4. DHCP ACK（确认）**

- **src: 223.1.2.5, 67**
    - 源IP：223.1.2.5（DHCP服务器）
    - 源端口：67
- **dest: 255.255.255.255, 68**
    - 目标IP：255.255.255.255（广播确认）
    - 目标端口：68
- **yiaddr: 223.1.2.4**
    - 确认分配给客户端的IP地址

#### **关键信息**

- **Transaction ID**: 654→655 用于匹配请求和响应
- **Lifetime**: 3600秒（IP地址租约时间为1小时）
- **客户端最终获得的IP**: 223.1.2.4
- **DHCP服务器IP**: 223.1.2.5

### DHCP 协议在应用层实现
- 报文封装到 UDP 数据报中
- IP 广播
- 链路层广播（eg. 以太网广播）

### DHCP 服务器构造 ack 报文
- 分配给客户的 IP 地址
- 子网掩码
- 默认网关
- DNS 服务器地址

## 网络地址转换 NAT
- Network Address Translation
- 动机
	- 只需/能在 ISP 申请 1 个 IP 地址
	- 本地网络设备 IP 地址的变更，无需通告外界网络
	- 变更 ISP 时，无需修改内部网络设备的 IP 地址
	- 内部网络设备对外界网络不可见，即不可寻址（安全）

![[Pasted image 20251020082339.png]]
两个替换：
- 源 IP 地址换成相同的
- 端口号换成不同的

### 实现
- 替换
	- 利用(NAT IP 地址, 新端口号)替换每个外出数据报的(源 IP 地址, 源端口号)
- 记录
	- 将每对(NAT IP 地址, 新端口号)、(源 IP 地址, 源端口号)的替换信息存储到 NAT 转换表中
- 替换
	- 根据 NAT 转换表，替换回来

![[Pasted image 20251020082947.png]]
### NAT 争议
- 路由器应该只处理第 3 层功能
- 违背端到端通信原则
	- 应用开发者必须考虑到 NAT 的存在
- 地址短缺问题应该由 IPv6 解决

### NAT 穿透问题
- 客户期望连接特定内网地址的服务器：
	- 解决方案1: 静态配置 NAT
	- 解决方案2: 利用 UPnP Universal Plug and Play 互联网网关设备协议 IGD Internet Gateway Device 自动配置
	- 解决方案3: 中继服务器
