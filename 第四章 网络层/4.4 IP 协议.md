### IP 分组格式
![[Pasted image 20251013085846.png]]

路由器每次转发是否需要重新计算校验和？
每次转发 TTL 必减 1，故必然需要重新计算校验和。
$\Longrightarrow$ 不利于速度

### 最大传输单元 MTU Max Transmission Unit

链路层数据帧可封装数据的上限
大 IP 分组向较小 MTU 链路转发时，可以被分片 fragmented
- 1 个 IP 分组分为多片 IP 分组
- IP 分片到达目的主机后进行重组 reassembled

### IP 分片
计算公式：
$d = \lfloor \frac{M-20}{8} \rfloor \times 8$ 
$n = \lceil \frac{L-20}{d} \rceil$ 
例题：
![[Pasted image 20251013091102.png]]
**第一个分片：**

- 总长度：1500B = 20B头部 + 1480B数据
- 数据：1480B ✓（1480/8 = 185）

**第二个分片：**

- 总长度：1500B = 20B头部 + 1480B数据
- 数据：1480B ✓
- offset = 1480/8 = 185

**第三个分片：**

- 剩余数据 = 4000 - 20（原IP头）- 1480 - 1480 = **1020B**
- 总长度 = 20B头部 + 1020B数据 = **1040B** ✓
- offset = (1480 + 1480)/8 = 370
![[Pasted image 20251013091539.png]]
### IP 编址

#### IP 子网
- IP地址具有相同网络号的设备接口
- 不跨越路由器（第三及以上层网络设备）可以彼此物理联通的接口
![[Pasted image 20251013092113.png]]
6 个

#### 有类编址
![[Pasted image 20251013092513.png]]
IP 地址的利用效率比较低
#### 特殊 IP 地址
![[Pasted image 20251013092827.png]]
#### 私有 IP 地址  Private
![[Pasted image 20251013092912.png]]

#### 子网划分
区分一个子网更小范围的网络
![[Pasted image 20251013093158.png]]
#### 无类域间路由 Classless InterDomain Routing
- 消除传统的 ABC 类地址界限
	- NetID+SubID -> Network Prefix
- 融合子网地址与子网掩码，方便子网划分
	- 格式：a.b.c.d/x, x 为前缀长度
- 提高 IPv4 地址空间分配效率
- 提高路由效率
	- 多个子网聚合为一个较大的子网
	- 构造超网 supernetting
- 路由聚合

#### 路由聚合
![[Pasted image 20251015101533.png]]
由于 最长前缀匹配优先 规则，路由聚合在提高效率的同时仍然是正确的。

### IPv6
#### 动机
- 32 位 IPv4 地址不够用
- 改进首部格式
	- 快速处理/转发数据报
	- 支持QoS

#### 数据报格式
- 固定长度 40 字节基本首部
- 不允许分片
![[Pasted image 20251015102930.png]]
![[Pasted image 20251015103012.png]]
$2^{128}$ 足够大

#### 对比 IPv4
- 校验和 checksum ：彻底移除
- 选项 options ：允许，但是从基本首部移出，定义多个选项首部，通过“下一个首部”字段指示
- ICMPv6

#### 基本地址类型
- 单播 unicast：一对一通信
- 多播 multicast：一对多通信
- 任意播 anycast：一对一组之一（最近一个）通信

#### IPv4 向 IPv6 过渡
隧道 tunneling：IPv6 数据报作为 IPv4 数据报的载荷进行封装，穿越 IPv4 网络
![[Pasted image 20251015104247.png]]
